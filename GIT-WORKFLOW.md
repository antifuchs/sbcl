# A new Git workflow for SBCL

Here's how I imagine things could work. Since I have spoken only with
foom and nyef to any extent (and I have ignored a bunch of nyef's
suggestions), I definitely have gotten things wrong and am
misled.

The things we talked about on IRC, at least as far as I remember them:

1. Version numbering: Should we include a version number in a commit or not?
2. Commit message conventions: Include a version number?
3. How to make a release?

## Version numbering

Git makes it easier for anyone to create branches that run in parallel
to the current "master" timeline, so destroys the illusion of a single
official timeline defined through version.lisp-expr.

Anyone who publishes changes to SBCL, or even publishes binaries built
using an altered version, ends up having a binary that says it is made
from one version's sources, while it was made with sources that could
differ.

As I understand it, we have two options: Either rewrite git objects
when they're pushed to an origin repository to add version info, or
rely on "git describe" when building SBCL.

In my opinion, rewriting objects will work only on repositories that
are configured to work with this scheme, and adds unnecessary
complexity. Also, it has the potential to complicate pulling from
origin after pushing changes (AIUI, you have to reset your current
checkout to origin/master's idea of what your local HEAD is, in order
to continue).

This is why I strongly prefer the `git describe` option. Conveniently,
the describe mechanism already mimics the behavior of our current
version number scheme, and (added bonus!) version numbers generated by
`git describe` also allow us to paste the version number into `git
log`/`git show` and find out which commit it was exactly that was used
to build any binary.

###Proposed change to version numbering

 - Drop version.lisp-expr from the git tree (gitignore it),
 - auto-generate the version from git's idea of where the version fits
   into, given the curren tags (git describe),
 - auto-generate version.lisp-expr when creating a source release.

The build scripts in the `git-toolchain` branch generate a
version.lisp-expr with this format:

    ;;; This is an auto-generated file, using git describe.
    ;;; Every time you re-run make.sh, this file will be overwritten.
    "1.0.45.14-g1cd3d"

These are its components:

 1. Version number, according to the old naming convention.
 2. Optional git object identifier, if the current revision is not on a tag.
 
This version number can be used on the shell with "git log" to look up
the precise revision used to build sbcl.

If you really really don't like the git hash in there, you can pass
NO_GIT_HASH_IN_VERSION=t to make.sh - that will make the version
number generator strip out the hash. We *can* make this the the normal
mode of operation, but I think that hash makes version numbers a lot
more useful to people building unreleased SBCLs.

## Version numbers in commit messages

Currently, we put the version number in the commit "subject line" (the
first line in a commit). With auto-generated version numbers, this
won't be feasible anymore.

###Proposed change to commit subject line convention

Don't include the version number in commit messages anymore. This
frees up 8 characters of prime description real estate, too.

Leave the rest of the commit message convention in place: SBCL's
commit messages are very good, typically, so we must be doing
something right. (-:

## Making a release (release.sh)

Short story: use `release.sh`.

I've updated `release.sh` to make a release *locally.* This means it
will perform all actions required for the release in the local git
checkout, and will then instruct you how to proceed in order to push
the release to the outside world.

###Synopsis:

    ./release.sh VERSION [-s]

**VERSION** is the version to make a release for. Example: `1.0.46`.

**-s** instructs `git tag` to create a gpg-signed tag for this
release. Highly recommended.

###Description:

`release.sh` will perform these actions:

* Check that the local checkout is clean.
* Update NEWS and make a commit stating the release version number
* Make an sbcl.<VERSION> tag and optionally sign it.
* Build SBCL
* Run tests
* Build SBCL with the SBCL that just had tests pass
* Build docs
* Create source, binary, documentation tarballs
* Sign these tarballs
* Give you further instructions.

After release.sh is done, you can inspect the results, and commence
struggling with the SF.net file release system from hell. You are very
brave.